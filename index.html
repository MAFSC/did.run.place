<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DID Anchor dApp ¬∑ Base Sepolia ¬∑ QR (WalletConnect)</title>
<style>
  :root{--bg:#0b0d10;--card:#141820;--muted:#8a94a7}
  *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;background:var(--bg);color:#e5ebf5}
  .wrap{max-width:900px;margin:0 auto;padding:28px}
  .card{background:#141820;border:1px solid #1f2430;border-radius:16px;padding:18px}
  h1{margin:0 0 12px;font-size:22px}.muted{color:var(--muted)}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  input[type=text],input[type=file]{width:100%;background:#0f131a;border:1px solid #202634;border-radius:12px;padding:12px 14px;color:#e5ebf5}
  .btn{border:1px solid #2c3545;background:#101521;color:#e5ebf5;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#22d3ee,#a78bfa);border:none}
  .log{background:#0f131a;border:1px dashed #293248;border-radius:12px;padding:12px;min-height:140px;white-space:pre-wrap}
  .kvs{display:grid;grid-template-columns:160px 1fr;gap:8px;font-size:13px}
  a.link{color:#8dd6ff;text-decoration:none}
</style>
<!-- Ethers v6 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js" crossorigin="anonymous"></script>
<!-- WalletConnect v2 Ethereum Provider (UMD —Å QR-–º–æ–¥–∞–ª–∫–æ–π) -->
<script src="https://unpkg.com/@walletconnect/ethereum-provider@2/dist/index.umd.js"></script>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>DID Anchor dApp <span style="font-size:12px;color:#9fb3c8">Base Sepolia ¬∑ QR</span></h1>
  <p class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR –≤ Phantom (EVM) / MetaMask Mobile. DApp –ø–æ—Å—á–∏—Ç–∞–µ—Ç <span class="mono">keccak256(file)</span>, –∑–∞–ª—å—ë—Ç —Ñ–∞–π–ª –∏ metadata –≤ IPFS (web3.storage) –∏ –≤—ã–∑–æ–≤–µ—Ç <span class="mono">anchor</span> –Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ.</p>

  <h3>1) –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ (QR)</h3>
  <div class="row" style="margin-bottom:10px">
    <button id="btnConnectQR" class="btn primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ QR (WalletConnect)</button>
    <button id="btnClear" class="btn">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
  </div>
  <div class="row" style="margin-bottom:14px">
    <button id="btnEnsureBase" class="btn">–£–±–µ–¥–∏—Ç—å—Å—è –≤ —Å–µ—Ç–∏ Base Sepolia</button>
    <a id="basescan" class="btn" target="_blank" rel="noopener">Basescan</a>
  </div>
  <div id="who" class="kvs" style="display:none;margin-bottom:10px">
    <div>–ê–¥—Ä–µ—Å</div><div class="mono" id="addr">‚Äî</div>
    <div>–°–µ—Ç—å</div><div class="mono" id="net">‚Äî</div>
  </div>

  <h3>2) IPFS —Ç–æ–∫–µ–Ω (web3.storage)</h3>
  <input type="text" id="w3stoken" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ Web3.Storage API Token"/>

  <h3>3) –§–∞–π–ª –∏ –¥–∞–Ω–Ω—ã–µ</h3>
  <div class="row" style="margin-bottom:10px">
    <input type="text" id="project" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (–≤ NFT)"/>
    <input type="file" id="file" accept=".pdf,.txt,.md,.doc,.docx"/>
  </div>
  <div class="row" style="margin-bottom:8px">
    <button id="btnGo" class="btn primary">‚õìÔ∏è Anchor & Mint</button>
  </div>

  <h3>–õ–æ–≥</h3>
  <div id="log" class="log"></div>

  <div style="margin-top:10px;color:#9fb3c8;font-size:12px">
    –ö–æ–Ω—Ç—Ä–∞–∫—Ç: <span class="mono" id="caddr">0x652Aec14a474dEb389574955d234C742D1936bE5</span> ¬∑
    –°–µ—Ç—å: <span class="mono">Base Sepolia (84532)</span> ¬∑
    –§–∞—É—Å–µ—Ç: <a class="link" href="https://www.alchemy.com/faucets/base-sepolia" target="_blank">Alchemy Faucet</a>
  </div>
</div></div>

<script>
(async function(){
  // ==== –ù–ê–°–¢–†–û–ô–ö–ò ====
  const CONTRACT_ADDRESS = "0x652Aec14a474dEb389574955d234C742D1936bE5";
  const WC_PROJECT_ID    = "PASTE_YOUR_WALLETCONNECT_PROJECT_ID_HERE"; // <‚Äî –í–°–¢–ê–í–¨ –°–í–û–ô projectId —Å https://cloud.walletconnect.com
  const BASE_SEPOLIA = {
    chainId: 84532,
    hex: "0x14A34",
    name: "Base Sepolia",
    rpcUrl: "https://sepolia.base.org",
    explorer: "https://sepolia.basescan.org"
  };
  const ABI = [
    "function anchor(bytes32 docHash, string fileCID, string tokenURI) external returns (uint256)",
    "function tokenCounter() view returns (uint256)"
  ];

  const $ = (id)=>document.getElementById(id);
  const log = (m)=>{ const el=$("log"); el.textContent+=(m+"\n"); el.scrollTop=el.scrollHeight; };
  const setKV=(k,v)=>$(k).textContent=v;
  $("basescan").href = `${BASE_SEPOLIA.explorer}/address/${CONTRACT_ADDRESS}`;
  $("caddr").textContent = CONTRACT_ADDRESS;

  // ==== –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ====
  let wcProvider = null;          // EIP-1193 –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ—Ç WalletConnect
  let ethersProvider = null;      // ethers.BrowserProvider –æ–±–µ—Ä—Ç–∫–∞
  let signer = null;
  let account = null;

  // –°–æ–∑–¥–∞—Ç—å/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å WalletConnect –ø—Ä–æ–≤–∞–π–¥–µ—Ä (–ø–æ–∫–∞–∂–µ—Ç QR –ø—Ä–∏ enable)
  async function createWCProvider() {
    if (!WC_PROJECT_ID || WC_PROJECT_ID.includes("PASTE_YOUR")) {
      throw new Error("–ù–µ —É–∫–∞–∑–∞–Ω WalletConnect projectId. –ü–æ–ª—É—á–∏—Ç–µ –µ–≥–æ –Ω–∞ cloud.walletconnect.com –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É WC_PROJECT_ID.");
    }
    const EthereumProvider = window.WalletConnectEthereumProvider?.default || window.WalletConnectEthereumProvider;
    if (!EthereumProvider) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å WalletConnect Ethereum Provider (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ CDN-—Å–∫—Ä–∏–ø—Ç).");

    // chains ‚Äî —ç—Ç–æ CAIP chain ids (EVM) –ø–æ –Ω–æ–º–µ—Ä–∞–º. –î–ª—è Base Sepolia ‚Äî 84532.
    wcProvider = await EthereumProvider.init({
      projectId: WC_PROJECT_ID,
      chains: [BASE_SEPOLIA.chainId],
      optionalChains: [BASE_SEPOLIA.chainId],
      showQrModal: true,
      rpcMap: { [BASE_SEPOLIA.chainId]: BASE_SEPOLIA.rpcUrl },
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å metadata dApp:
      metadata: {
        name: "DID Anchor dApp",
        description: "Anchor whitepaper & mint NFT on Base Sepolia",
        url: window.location.origin,
        icons: ["https://avatars.githubusercontent.com/u/6250754?s=200&v=4"]
      }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å/—Å–µ—Ç—å –ø–æ —Å–æ–±—ã—Ç–∏—è–º
    wcProvider.on("accountsChanged", async (accs) => {
      account = accs?.[0] || null;
      setKV("addr", account || "‚Äî");
    });
    wcProvider.on("chainChanged", async (chainIdHex) => {
      const chainNum = Number(chainIdHex);
      setKV("net", `chainId ${chainNum}`);
    });
    wcProvider.on("disconnect", () => {
      log("‚ÑπÔ∏è WalletConnect –æ—Ç–∫–ª—é—á–µ–Ω");
      $("who").style.display = "none";
      wcProvider = null; ethersProvider = null; signer = null; account = null;
    });

    return wcProvider;
  }

  async function connectByQR(){
    try {
      if (!wcProvider) await createWCProvider();
      // –û—Ç–∫—Ä–æ–µ—Ç QR-–º–æ–¥–∞–ª–∫—É –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å–µ—Å—Å–∏—é
      await wcProvider.enable();

      ethersProvider = new ethers.BrowserProvider(wcProvider);
      signer = await ethersProvider.getSigner();
      const net = await ethersProvider.getNetwork();
      const accs = await wcProvider.request({ method: "eth_accounts" });
      account = accs?.[0] || (await signer.getAddress());

      setKV("addr", account);
      setKV("net", `${net.name || "Base Sepolia"} (${Number(net.chainId)})`);
      $("who").style.display = "grid";
      log("‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ —á–µ—Ä–µ–∑ WalletConnect: " + account);

      // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Å–µ—Ç—å –Ω–µ —Ç–∞ ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å
      await ensureBaseSepolia();
    } catch (e) {
      console.error(e);
      log("‚ùå " + (e.message || e));
      alert(e.message || e);
    }
  }

  // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–∞ Base Sepolia
  async function ensureBaseSepolia(){
    if (!wcProvider) throw new Error("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ —á–µ—Ä–µ–∑ QR.");
    const net = await (new ethers.BrowserProvider(wcProvider)).getNetwork();
    if (Number(net.chainId) === BASE_SEPOLIA.chainId) {
      setKV("net", `${net.name || "Base Sepolia"} (${Number(net.chainId)})`);
      return;
    }
    try {
      await wcProvider.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: BASE_SEPOLIA.hex }]
      });
    } catch (e) {
      if (e && (e.code === 4902 || /Unrecognized/i.test(String(e.message||"")))) {
        await wcProvider.request({
          method: "wallet_addEthereumChain",
          params: [{
            chainId: BASE_SEPOLIA.hex,
            chainName: BASE_SEPOLIA.name,
            nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
            rpcUrls: [BASE_SEPOLIA.rpcUrl],
            blockExplorerUrls: [BASE_SEPOLIA.explorer]
          }]
        });
      } else {
        throw e;
      }
    }
    const net2 = await (new ethers.BrowserProvider(wcProvider)).getNetwork();
    setKV("net", `${net2.name || "Base Sepolia"} (${Number(net2.chainId)})`);
    log("‚úì –°–µ—Ç—å: Base Sepolia");
  }

  async function uploadWeb3Storage(token, fileOrBlob){
    if(!token) throw new Error("–£–∫–∞–∂–∏—Ç–µ Web3.Storage token");
    const res = await fetch("https://api.web3.storage/upload", {
      method:"POST", headers:{ Authorization:`Bearer ${token}` }, body:fileOrBlob
    });
    if(!res.ok) throw new Error("Web3.Storage error: "+res.status+" "+res.statusText);
    const js = await res.json();
    return js.cid;
  }

  async function anchorAndMint(){
    try {
      if (!signer) await connectByQR();
      await ensureBaseSepolia();

      const f = $("file").files[0];
      const name = ($("project").value || "Whitepaper").trim();
      const token = $("w3stoken").value.trim();
      if(!f) throw new Error("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");

      // keccak256(file)
      const buf = new Uint8Array(await f.arrayBuffer());
      const docHash = ethers.keccak256(buf);
      log("üîí docHash: "+docHash);

      // IPFS
      const fileCID = await uploadWeb3Storage(token, f);
      log("üìÑ File CID: "+fileCID);

      const metadata = {
        name,
        description: "Anchored whitepaper bound to an EVM address on Base Sepolia",
        attributes: [
          { trait_type:"docHash", value:docHash },
          { trait_type:"fileCID", value:fileCID },
          { trait_type:"anchoredAt", value:new Date().toISOString() }
        ]
      };
      const metaCID = await uploadWeb3Storage(token, new Blob([JSON.stringify(metadata)], {type:"application/json"}));
      const tokenURI = `ipfs://${metaCID}`;
      log("üßæ Metadata CID: "+metaCID+"\nüîó tokenURI: "+tokenURI);

      // –ö–æ–Ω—Ç—Ä–∞–∫—Ç
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      const tx = await contract.anchor(docHash, fileCID, tokenURI);
      $("basescan").href = `${BASE_SEPOLIA.explorer}/tx/${tx.hash}`;
      log("‚è±Ô∏è tx: "+tx.hash);
      const rcpt = await tx.wait();
      const tid = (await contract.tokenCounter()).toString();
      log("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –≤ –±–ª–æ–∫–µ "+rcpt.blockNumber+"\nüé® tokenId: "+tid);

      const did = { id:`did:ethr:${account}#whitepaper`, type:"DocumentAnchor",
        serviceEndpoint:{ docHash, fileCID:`ipfs://${fileCID}`, nftContract:CONTRACT_ADDRESS, tokenId:tid } };
      log("\nüëâ DID service entry:\n"+JSON.stringify(did,null,2));
    } catch (e) {
      console.error(e);
      log("‚ùå "+(e.message||e));
      alert(e.message||e);
    }
  }

  // ==== –ö–Ω–æ–ø–∫–∏ ====
  document.getElementById("btnConnectQR").onclick = connectByQR;
  document.getElementById("btnEnsureBase").onclick = ensureBaseSepolia;
  document.getElementById("btnGo").onclick = anchorAndMint;
  document.getElementById("btnClear").onclick = ()=>{ $("log").textContent=""; };

  // –ü–æ–¥—Å–∫–∞–∑–∫–∞
  log("‚ÑπÔ∏è –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω—É–∂–µ–Ω WalletConnect projectId –≤ –∫–æ–¥–µ (WC_PROJECT_ID). –ú–æ–±–∏–ª—å–Ω—ã–π Phantom/MetaMask –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ Base Sepolia.");
})();
</script>
</body>
</html>
