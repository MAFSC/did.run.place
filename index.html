<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DID Anchor dApp ¬∑ Base Sepolia</title>
<style>
  :root{--bg:#0b0d10;--card:#141820;--muted:#8a94a7}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;background:var(--bg);color:#e5ebf5}
  .wrap{max-width:900px;margin:0 auto;padding:28px}
  .card{background:#141820;border:1px solid #1f2430;border-radius:16px;padding:18px}
  h1{margin:0 0 12px;font-size:22px}.muted{color:var(--muted)}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  input[type=text],input[type=file],select{width:100%;background:#0f131a;border:1px solid #202634;border-radius:12px;padding:12px 14px;color:#e5ebf5}
  .btn{border:1px solid #2c3545;background:#101521;color:#e5ebf5;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#22d3ee,#a78bfa);border:none}
  .log{background:#0f131a;border:1px dashed #293248;border-radius:12px;padding:12px;min-height:120px;white-space:pre-wrap}
  .kvs{display:grid;grid-template-columns:160px 1fr;gap:8px;font-size:13px}
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js" crossorigin="anonymous"></script>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>DID Anchor dApp <span style="font-size:12px;color:#9fb3c8">Base Sepolia</span></h1>
  <p class="muted">–ü–æ–¥–∫–ª—é—á–∏ Phantom (EVM) / MetaMask, –∑–∞–≥—Ä—É–∑–∏–º whitepaper, –ø–æ—Å—á–∏—Ç–∞–µ–º <span class="mono">keccak256</span>, –∑–∞–ª—å—ë–º –≤ IPFS (web3.storage) –∏ –≤—ã–∑–æ–≤–µ–º <span class="mono">anchor</span> –Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ.</p>

  <h3>1) –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∫–æ—à–µ–ª—å–∫–∞</h3>
  <div class="row" style="margin-bottom:10px">
    <select id="providerSelect"></select>
    <button id="btnConnect" class="btn primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
  </div>
  <div class="row" style="margin-bottom:14px">
    <button id="btnSwitch" class="btn">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–µ—Ç—å ‚Üí Base Sepolia</button>
    <button id="btnClear" class="btn">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
  </div>
  <div id="who" class="kvs" style="display:none;margin-bottom:10px">
    <div>–ê–¥—Ä–µ—Å</div><div class="mono" id="addr">‚Äî</div>
    <div>–°–µ—Ç—å</div><div class="mono" id="net">‚Äî</div>
  </div>

  <h3>2) IPFS —Ç–æ–∫–µ–Ω (web3.storage)</h3>
  <input type="text" id="w3stoken" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ Web3.Storage API Token"/>

  <h3>3) –§–∞–π–ª –∏ –¥–∞–Ω–Ω—ã–µ</h3>
  <div class="row" style="margin-bottom:10px">
    <input type="text" id="project" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (–≤ NFT)"/>
    <input type="file" id="file" accept=".pdf,.txt,.md,.doc,.docx"/>
  </div>
  <div class="row" style="margin-bottom:8px">
    <button id="btnGo" class="btn primary">‚õìÔ∏è Anchor & Mint</button>
    <a id="basescan" class="btn" target="_blank" rel="noopener">Basescan</a>
  </div>

  <h3>–õ–æ–≥</h3>
  <div id="log" class="log"></div>

  <div style="margin-top:10px;color:#9fb3c8;font-size:12px">
    –ö–æ–Ω—Ç—Ä–∞–∫—Ç: <span class="mono" id="caddr">0x652Aec14a474dEb389574955d234C742D1936bE5</span>
  </div>
</div></div>

<script>
(function(){
  const CONTRACT_ADDRESS = "0x652Aec14a474dEb389574955d234C742D1936bE5";
  const BASE_SEPOLIA = {
    chainId: "0x14A34", // 84532
    chainName: "Base Sepolia",
    nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
    rpcUrls: ["https://sepolia.base.org","https://base-sepolia.g.alchemy.com/v2/demo"],
    blockExplorerUrls: ["https://sepolia.basescan.org"]
  };
  const ABI = [
    "function anchor(bytes32 docHash, string fileCID, string tokenURI) external returns (uint256)",
    "function tokenCounter() view returns (uint256)"
  ];
  const $ = (id)=>document.getElementById(id);
  const log = (m)=>{ const el=$("log"); el.textContent+=(m+"\n"); el.scrollTop=el.scrollHeight; };
  const setKV=(k,v)=>$(k).textContent=v;
  $("basescan").href = "https://sepolia.basescan.org/address/"+CONTRACT_ADDRESS;

  // ---- EIP-6963 –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ + —Ñ–æ–ª–±—ç–∫–∏ ----
  const providers = [];
  function addProvider(info, provider){
    providers.push({ info, provider });
    const sel = $("providerSelect");
    const opt = document.createElement("option");
    opt.value = String(providers.length - 1);
    opt.textContent = `${info.walletId || info.name || "Wallet"} ‚Äî ${info.rdns || ""}`;
    sel.appendChild(opt);
  }
  window.addEventListener("eip6963:announceProvider", (event) => {
    const { detail } = event;
    if (!providers.find(p => p.provider === detail.provider)) {
      addProvider(detail.info, detail.provider);
    }
  });
  window.dispatchEvent(new Event("eip6963:requestProvider"));

  // –§–æ–ª–±—ç–∫: Phantom EVM –∏ –æ–±—ã—á–Ω—ã–π EIP-1193
  if (window.phantom && window.phantom.ethereum) {
    addProvider({ name: "Phantom (EVM)", walletId: "phantom.evm", rdns: "phantom.app" }, window.phantom.ethereum);
  }
  if (window.ethereum && !providers.find(p=>p.provider===window.ethereum)) {
    addProvider({ name: "Injected (ethereum)", walletId: "injected", rdns: "eip1193" }, window.ethereum);
  }
  if (providers.length===0) {
    const sel = $("providerSelect");
    const opt = document.createElement("option");
    opt.value = "-1";
    opt.textContent = "–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Phantom (EVM) –∏–ª–∏ MetaMask";
    sel.appendChild(opt);
  }

  let selected, ethersProvider, signer, account;

  $("providerSelect").addEventListener("change", (e)=>{
    const idx = Number(e.target.value);
    selected = (idx>=0) ? providers[idx]?.provider : undefined;
  });
  // –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  if (providers.length>0) { $("providerSelect").value = "0"; selected = providers[0].provider; }

  async function connect(){
    try{
      if(!selected) throw new Error("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Phantom (–≤–∫–ª—é—á–∏—Ç–µ EVM –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö) –∏–ª–∏ MetaMask.");
      // –∑–∞–ø—Ä–æ—Å –∞–∫–∫–∞—É–Ω—Ç–æ–≤
      const accs = await selected.request({ method:"eth_requestAccounts" });
      account = accs && accs[0];
      if(!account) throw new Error("–ö–æ—à–µ–ª—ë–∫ –Ω–µ –≤—ã–¥–∞–ª –∞–¥—Ä–µ—Å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –≤–∫–ª—é—á—ë–Ω –ª–∏ EVM –≤ Phantom: Settings ‚Üí Developer ‚Üí Enable Ethereum.");
      ethersProvider = new ethers.BrowserProvider(selected);
      signer = await ethersProvider.getSigner();
      const net = await ethersProvider.getNetwork();
      setKV("addr", account);
      setKV("net", `${net.name} (${Number(net.chainId)})`);
      $("who").style.display="grid";
      log("‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: "+account);
    }catch(e){ console.error(e); log("‚ùå "+(e.message||e)); alert(e.message||e); }
  }

  async function switchToBase(){
    if(!selected){ alert("–ù–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"); return; }
    try{
      await selected.request({ method: "wallet_switchEthereumChain", params: [{ chainId: BASE_SEPOLIA.chainId }] });
    }catch(e){
      // –µ—Å–ª–∏ —Å–µ—Ç—å –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞
      if (e && (e.code === 4902 || /Unrecognized/i.test(String(e.message||"")))) {
        await selected.request({ method:"wallet_addEthereumChain", params:[BASE_SEPOLIA] });
      } else { throw e; }
    }
    const net = await (new ethers.BrowserProvider(selected)).getNetwork();
    setKV("net", `${net.name} (${Number(net.chainId)})`);
    log("‚úì –°–µ—Ç—å: Base Sepolia");
  }

  async function uploadWeb3Storage(token, fileOrBlob){
    if(!token) throw new Error("–£–∫–∞–∂–∏—Ç–µ Web3.Storage token");
    const res = await fetch("https://api.web3.storage/upload", {
      method:"POST",
      headers:{ Authorization:`Bearer ${token}` },
      body:fileOrBlob
    });
    if(!res.ok) throw new Error("Web3.Storage error: "+res.status+" "+res.statusText);
    const js = await res.json();
    return js.cid;
  }

  async function run(){
    try{
      if(!signer) await connect();
      const net = await (new ethers.BrowserProvider(selected)).getNetwork();
      if(Number(net.chainId)!==84532) await switchToBase();

      const f = $("file").files[0];
      const name = ($("project").value || "Whitepaper").trim();
      const token = $("w3stoken").value.trim();
      if(!f) throw new Error("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");

      // keccak256(file)
      const buf = new Uint8Array(await f.arrayBuffer());
      const docHash = ethers.keccak256(buf);
      log("üîí docHash: "+docHash);

      // IPFS
      const fileCID = await uploadWeb3Storage(token, f);
      log("üìÑ File CID: "+fileCID);

      const metadata = {
        name,
        description: "Anchored whitepaper bound to an EVM address on Base Sepolia",
        attributes: [
          { trait_type:"docHash", value:docHash },
          { trait_type:"fileCID", value:fileCID },
          { trait_type:"anchoredAt", value:new Date().toISOString() }
        ]
      };
      const metaCID = await uploadWeb3Storage(token, new Blob([JSON.stringify(metadata)], {type:"application/json"}));
      const tokenURI = `ipfs://${metaCID}`;
      log("üßæ Metadata CID: "+metaCID+"\nüîó tokenURI: "+tokenURI);

      // –∫–æ–Ω—Ç—Ä–∞–∫—Ç
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      const tx = await contract.anchor(docHash, fileCID, tokenURI);
      log("‚è±Ô∏è tx: "+tx.hash);
      $("basescan").href = "https://sepolia.basescan.org/tx/"+tx.hash;
      const rcpt = await tx.wait();
      const tid = (await contract.tokenCounter()).toString();
      log("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –≤ –±–ª–æ–∫–µ "+rcpt.blockNumber+"\nüé® tokenId: "+tid);

      const did = { id:`did:ethr:${account}#whitepaper`, type:"DocumentAnchor",
        serviceEndpoint:{ docHash, fileCID:`ipfs://${fileCID}`, nftContract:CONTRACT_ADDRESS, tokenId:tid } };
      log("\nüëâ DID service entry:\n"+JSON.stringify(did,null,2));
    }catch(e){ console.error(e); log("‚ùå "+(e.message||e)); alert(e.message||e); }
  }

  $("btnConnect").onclick = connect;
  $("btnSwitch").onclick  = switchToBase;
  $("btnGo").onclick      = run;
  $("btnClear").onclick   = ()=>{ $("log").textContent=""; };

  // –ü–æ–¥—Å–∫–∞–∑–∫–∞, –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Phantom –±–µ–∑ EVM
  if (window.phantom && !window.phantom.ethereum) {
    log("‚ÑπÔ∏è –ù–∞–π–¥–µ–Ω Phantom (Solana). –í–∫–ª—é—á–∏—Ç–µ EVM: Settings ‚Üí Developer ‚Üí Enable Ethereum (Multi-chain). –ó–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä/–≤–∫–ª–∞–¥–∫—É.");
  }
})();
</script>
</body>
</html>
