<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DID Anchor dApp ¬∑ Base Sepolia ¬∑ Local IPFS + QR/Browser</title>
<style>
  :root{--bg:#0b0d10;--card:#141820;--muted:#8a94a7}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;background:var(--bg);color:#e5ebf5}
  .wrap{max-width:980px;margin:0 auto;padding:28px}
  .card{background:#141820;border:1px solid #1f2430;border-radius:16px;padding:18px}
  h1{margin:0 0 12px;font-size:22px}
  .muted{color:#8a94a7}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  input[type=text],input[type=number],input[type=file],select{width:100%;background:#0f131a;border:1px solid #202634;border-radius:12px;padding:12px 14px;color:#e5ebf5}
  .btn{border:1px solid #2c3545;background:#101521;color:#e5ebf5;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#22d3ee,#a78bfa);border:none}
  .warn{background:#20110f;border:1px solid #3a1c17;border-radius:12px;padding:12px;margin:10px 0;color:#ffb4a6}
  .ok{background:#112016;border:1px solid #1b3a2a;border-radius:12px;padding:12px;margin:10px 0;color:#b9ffcb}
  .log{background:#0f131a;border:1px dashed #293248;border-radius:12px;padding:12px;min-height:180px;white-space:pre-wrap}
  .kvs{display:grid;grid-template-columns:160px 1fr;gap:8px;font-size:13px}
  a.link{color:#8dd6ff;text-decoration:none}
</style>
<!-- ethers v6 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js" crossorigin="anonymous"></script>
<!-- –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π WalletConnect UMD; –ø—Ä–∏ –∫–ª–∏–∫–µ QR —Å–¥–µ–ª–∞–µ–º –∏ CDN-—Ñ–æ–ª–±—ç–∫ -->
<script src="/wc/index.umd.js" defer></script>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>DID Anchor dApp <span style="font-size:12px;color:#9fb3c8">Base Sepolia ¬∑ Local IPFS</span></h1>
  <p class="muted">
    –ü–æ–¥–∫–ª—é—á–∏ <b>Phantom/MetaMask (–±—Ä–∞—É–∑–µ—Ä)</b> –∏–ª–∏ <b>QR (WalletConnect)</b>.
    DApp —Å—á–∏—Ç–∞–µ—Ç <span class="mono">keccak256(file)</span>, –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª –∏ metadata –≤ <b>–ª–æ–∫–∞–ª—å–Ω—ã–π IPFS</b> (Kubo) –∏–ª–∏ <b>Web3.Storage</b>, –∏ –≤—ã–∑—ã–≤–∞–µ—Ç <span class="mono">anchor</span> –Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ.
  </p>

  <div class="warn"><b>–í–ê–ñ–ù–û:</b> –ù–∏–∂–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω <b>–ø–æ–ª–Ω—ã–π —Ñ–æ—Ä–µ–Ω–∑–∏–∫-—Ö—ç—à (CreatorProofHash)</b>. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ!
    –í NFT/–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ <b>–æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π</b> —Ö—ç—à. –ü–æ—Ç–µ—Ä—è–µ—Ç–µ –ø–æ–ª–Ω—ã–π ‚Äî –ø–æ—Ç–µ—Ä—è–µ—Ç–µ —Ä—ã—á–∞–≥–∏ –¥–æ–∫–∞–∑—ã–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞.
  </div>

  <h3>1) –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞</h3>
  <div class="row" style="margin-bottom:10px">
    <button id="btnConnectInjected" class="btn primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ (Phantom/MetaMask)</button>
    <button id="btnConnectQR" class="btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ QR (WalletConnect)</button>
  </div>
  <div class="row" style="margin-bottom:14px">
    <button id="btnEnsureBase" class="btn">–£–±–µ–¥–∏—Ç—å—Å—è –≤ —Å–µ—Ç–∏ Base Sepolia</button>
    <a id="basescan" class="btn" target="_blank" rel="noopener">Basescan</a>
  </div>
  <div id="who" class="kvs" style="display:none;margin-bottom:10px">
    <div>–ê–¥—Ä–µ—Å</div><div class="mono" id="addr">‚Äî</div>
    <div>–°–µ—Ç—å</div><div class="mono" id="net">‚Äî</div>
  </div>

  <h3>2) –•—Ä–∞–Ω–∏–ª–∏—â–µ</h3>
  <div class="row" style="margin-bottom:10px">
    <select id="storage">
      <option value="ipfs-local" selected>IPFS Local (http://127.0.0.1:5001/api/v0)</option>
      <option value="web3">Web3.Storage (–Ω—É–∂–µ–Ω —Ç–æ–∫–µ–Ω)</option>
    </select>
    <input type="text" id="ipfsApi" value="http://127.0.0.1:5001/api/v0" placeholder="IPFS API endpoint (add)"/>
  </div>
  <div class="row" id="w3sRow" style="display:none;margin-bottom:10px">
    <input type="text" id="w3stoken" placeholder="Web3.Storage API Token (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Web3.Storage)"/>
    <div></div>
  </div>

  <h3>3) –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ö—ç—à–∞</h3>
  <div class="row" style="margin-bottom:10px">
    <input type="text" id="project" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (–≤ NFT)"/>
    <input type="file" id="file" accept=".pdf,.txt,.md,.doc,.docx"/>
  </div>
  <div class="row" style="margin-bottom:10px">
    <input type="text" id="userSalt" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ (–∏–¥—ë—Ç –≤ —Ö—ç—à, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"/>
    <input type="number" id="truncateN" min="8" max="62" step="2" value="16" placeholder="–î–ª–∏–Ω–∞ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ —Ö—ç—à–∞ (hex)"/>
  </div>

  <div class="warn" id="fullHashBox" style="display:none">
    <div><b>–ü–æ–ª–Ω—ã–π CreatorProofHash:</b> <span class="mono" id="fullHash">‚Äî</span></div>
    <div style="margin-top:4px">–í NFT –ø–æ–ø–∞–¥—ë—Ç —Ç–æ–ª—å–∫–æ: <span class="mono" id="truncPreview">‚Äî</span></div>
  </div>

  <div class="row" style="margin-bottom:8px">
    <button id="btnGo" class="btn primary">‚õìÔ∏è Anchor & Mint</button>
    <button id="btnClear" class="btn">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
  </div>

  <h3>–õ–æ–≥</h3>
  <div id="log" class="log"></div>

  <div style="margin-top:10px;color:#9fb3c8;font-size:12px">
    –ö–æ–Ω—Ç—Ä–∞–∫—Ç: <span class="mono" id="caddr">0x652Aec14a474dEb389574955d234C742D1936bE5</span> ¬∑
    –°–µ—Ç—å: <span class="mono">Base Sepolia (84532)</span> ¬∑
    –§–∞—É—Å–µ—Ç: <a class="link" href="https://www.alchemy.com/faucets/base-sepolia" target="_blank">Alchemy Faucet</a>
  </div>
</div></div>

<script>
(function(){
  // ======= –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã =======
  const CONTRACT_ADDRESS = "0x652Aec14a474dEb389574955d234C742D1936bE5";
  const WC_PROJECT_ID    = "5a95e16a786fd5c436a5b7064b09a63c"; // ‚Üê –í–°–¢–ê–í–¨ –°–í–û–ô projectId
  const BASE_SEPOLIA = {
    chainId: 84532, hex: "0x14A34",
    name: "Base Sepolia",
    rpcUrl: "https://sepolia.base.org",
    explorer: "https://sepolia.basescan.org"
  };
  const ABI = [
    "function anchor(bytes32 docHash, string fileCID, string tokenURI) external returns (uint256)",
    "function tokenCounter() view returns (uint256)"
  ];

  const $  =(id)=>document.getElementById(id);
  const log=(m)=>{ const el=$("log"); el.textContent+=(m+"\\n"); el.scrollTop=el.scrollHeight; };
  const setKV=(k,v)=>$(k).textContent=v;

  $("basescan").href = `${BASE_SEPOLIA.explorer}/address/${CONTRACT_ADDRESS}`;
  $("caddr").textContent = CONTRACT_ADDRESS;

  // ======= –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã =======
  let providerType = null; // 'injected' | 'walletconnect'
  let ethProv = null;      // EIP-1193
  let ethersProvider = null, signer = null, account = null;

  // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Ç–æ–∫–µ–Ω–∞ Web3.Storage
  $("storage").addEventListener("change", ()=>{
    $("w3sRow").style.display = ($("storage").value === "web3") ? "grid" : "none";
  });

  // ======= –ó–∞–≥—Ä—É–∑–∫–∞ WC UMD (–ª–æ–∫–∞–ª—å–Ω–æ + CDN —Ñ–æ–ª–±—ç–∫) =======
  async function ensureWalletConnectUMD() {
    if (window.WalletConnectEthereumProvider || window.EthereumProvider) return;
    const loadScript = (src) => new Promise((res, rej) => {
      const s = document.createElement('script'); s.src = src;
      s.onload = res; s.onerror = () => rej(new Error('Failed '+src));
      document.head.appendChild(s);
    });
    try { await loadScript('/wc/index.umd.js'); } catch(_) {}
    if (window.WalletConnectEthereumProvider || window.EthereumProvider) return;
    try { await loadScript('https://unpkg.com/@walletconnect/ethereum-provider@2.21.8/dist/index.umd.js'); } catch(e){ console.error(e); }
  }

  // ======= –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π =======
  async function connectInjected(){
    if (!window.ethereum) { alert("–ë—Ä–∞—É–∑–µ—Ä–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Phantom (Enable Ethereum) –∏–ª–∏ MetaMask."); return; }
    ethProv = window.ethereum; providerType='injected';
    await ethProv.request({ method:"eth_requestAccounts" });
    ethersProvider = new ethers.BrowserProvider(ethProv);
    signer = await ethersProvider.getSigner();
    account = await signer.getAddress();
    const net = await ethersProvider.getNetwork();
    setKV("addr", account); setKV("net", `${net.name || 'EVM'} (${Number(net.chainId)})`);
    $("who").style.display="grid";
    log("‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ: "+(ethProv.isPhantom?"Phantom":ethProv.isMetaMask?"MetaMask":"EVM wallet"));
    await ensureBaseSepolia();
  }

  // ======= –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: QR (WalletConnect) =======
  async function connectQR(){
    await ensureWalletConnectUMD();
    const WCGlobal = window.WalletConnectEthereumProvider || window.EthereumProvider;
    if (!WCGlobal) { alert("QR –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å WalletConnect UMD (–ª–æ–∫–∞–ª—å–Ω–æ –∏ —á–µ—Ä–µ–∑ CDN)."); log("‚ùå QR: UMD –Ω–µ –Ω–∞–π–¥–µ–Ω."); return; }
    if (!WC_PROJECT_ID || WC_PROJECT_ID.includes("PASTE_YOUR")) { alert("–£–∫–∞–∂–∏ WalletConnect projectId –≤ –∫–æ–¥–µ (WC_PROJECT_ID)."); return; }
    const EthereumProvider = WCGlobal.default || WCGlobal;
    ethProv = await EthereumProvider.init({
      projectId: WC_PROJECT_ID,
      chains:[BASE_SEPOLIA.chainId],
      optionalChains:[BASE_SEPOLIA.chainId],
      rpcMap:{[BASE_SEPOLIA.chainId]: BASE_SEPOLIA.rpcUrl},
      showQrModal:true,
      metadata:{ name:"DID Anchor dApp", description:"Anchor & Mint on Base Sepolia", url:location.origin, icons:["https://did.run.place/favicon.ico"] }
    });
    providerType='walletconnect';
    await ethProv.enable();
    ethersProvider = new ethers.BrowserProvider(ethProv);
    signer = await ethersProvider.getSigner();
    const accs = await ethProv.request({method:"eth_accounts"});
    account = accs?.[0] || (await signer.getAddress());
    const net = await ethersProvider.getNetwork();
    setKV("addr", account); setKV("net", `${net.name || 'Base Sepolia'} (${Number(net.chainId)})`);
    $("who").style.display="grid";
    log("‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ —á–µ—Ä–µ–∑ WalletConnect (QR): "+account);
    await ensureBaseSepolia();
  }

  // ======= –°–µ—Ç—å Base Sepolia =======
  async function ensureBaseSepolia(){
    if (!ethProv) { alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫."); return; }
    const net = await (new ethers.BrowserProvider(ethProv)).getNetwork();
    if (Number(net.chainId) === BASE_SEPOLIA.chainId) { setKV("net", `${net.name||"Base Sepolia"} (${Number(net.chainId)})`); return; }
    try {
      await ethProv.request({ method:"wallet_switchEthereumChain", params:[{ chainId: BASE_SEPOLIA.hex }] });
    } catch (e) {
      if (e && (e.code===4902 || /Unrecognized/i.test(String(e.message||"")))) {
        await ethProv.request({ method:"wallet_addEthereumChain", params:[{
          chainId: BASE_SEPOLIA.hex, chainName: BASE_SEPOLIA.name,
          nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18},
          rpcUrls:[BASE_SEPOLIA.rpcUrl], blockExplorerUrls:[BASE_SEPOLIA.explorer]
        }]});
      } else { throw e; }
    }
    const net2 = await (new ethers.BrowserProvider(ethProv)).getNetwork();
    setKV("net", `${net2.name||"Base Sepolia"} (${Number(net2.chainId)})`);
    log("‚úì –°–µ—Ç—å: Base Sepolia");
  }

  // ======= –§–æ—Ä–µ–Ω–∑–∏–∫-–º–µ—Ç—Ä–∏–∫–∏ =======
  const vowelsRe = /[AEIOUY–ê–ï–Å–ò–û–£–´–≠–Æ–Øaeiouy–∞–µ—ë–∏–æ—É—ã—ç—é—è]/u;
  function computeStats(txt){
    const letters = txt.match(/\p{L}/gu) || [];
    const words   = txt.match(/\p{L}+/gu) || [];
    const spaces  = (txt.match(/[\u0020]/g) || []).length;
    const points  = (txt.match(/[.]/g) || []).length;
    const commas  = (txt.match(/[,]/g) || []).length;
    const punct   = (txt.match(/[!"#$%&'()*+,\-.\/:;<=>?@[\\\]^_`{|}~‚Ä¶‚Äî‚Äì]/g) || []).length;
    let vowels=0, consonants=0, upper=0, lower=0;
    letters.forEach(ch=>{
      const isVowel = vowelsRe.test(ch);
      if (isVowel) vowels++; else consonants++;
      if (ch === ch.toUpperCase() && ch !== ch.toLowerCase()) upper++;
      if (ch === ch.toLowerCase() && ch !== ch.toUpperCase()) lower++;
    });
    const freqInit = {};
    const alph = [..."ABCDEFGHIJKLMNOPQRSTUVWXYZ"];
    const calph = [..."–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø"];
    [...alph, ...calph].forEach(l=>freqInit[l]=0);
    words.forEach(w=>{
      const first = w[0].toUpperCase();
      if (freqInit[first]!=null) freqInit[first] += 1;
    });
    return { totalLetters: letters.length, totalWords: words.length, vowels, consonants, spaces,
      punctuationTotal: punct, dots: points, commas, uppercase: upper, lowercase: lower, freqInitialLetter: freqInit };
  }
  function nowWithHiRes(){
    const iso = new Date().toISOString();
    const perf = (typeof performance!=="undefined" && performance.now) ? performance.now() : Math.random()*1e3;
    const micro = Math.round(perf*1000); // Œºs
    const nonce = crypto.getRandomValues(new Uint32Array(2));
    return { iso, micro, nonce: Array.from(nonce) };
  }
  const keccakHex = (u8)=>ethers.keccak256(u8);
  async function fileToUint8(file){ const buf = await file.arrayBuffer(); return new Uint8Array(buf); }

  // ======= –ü—Ä–æ–≤–µ—Ä–∫–∞ Local IPFS + Web3.Storage —Ä–µ—Ç—Ä–∞–∏ =======
  async function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
  async function checkLocalIpfsReachable(apiBase){
    try { const res = await fetch(apiBase.replace(/\/+$/,'')+"/version",{method:"POST"}); return res.ok; }
    catch { return false; }
  }
  async function uploadWeb3StorageWithRetry(token, blob, maxRetries = 5){
    if(!token) throw new Error("–£–∫–∞–∂–∏—Ç–µ Web3.Storage —Ç–æ–∫–µ–Ω");
    let attempt = 0, lastErr;
    while (attempt <= maxRetries){
      try{
        const res = await fetch("https://api.web3.storage/upload",{method:"POST",headers:{Authorization:`Bearer ${token}`},body: blob});
        if (res.status===401||res.status===403) throw new Error("Web3.Storage unauthorized (–ø—Ä–æ–≤–µ—Ä—å —Ç–æ–∫–µ–Ω)");
        if (!res.ok){
          if ((res.status===429||res.status===503) && attempt<maxRetries){ attempt++; await sleep(1000*attempt); continue; }
          throw new Error(`Web3.Storage error: ${res.status} ${res.statusText}`);
        }
        const j = await res.json();
        if (!j?.cid) throw new Error("Web3.Storage: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç");
        return j.cid;
      }catch(e){ lastErr=e; if (String(e).includes("Failed to fetch") && attempt<maxRetries){ attempt++; await sleep(1000*attempt); continue; } break; }
    }
    throw lastErr || new Error("Web3.Storage: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å");
  }
  async function ipfsAddLocal(apiBase, blob){
    const reachable = await checkLocalIpfsReachable(apiBase);
    if (!reachable) throw new Error("Local IPFS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ (127.0.0.1:5001). –û—Ç–∫—Ä–æ–π —Å–∞–π—Ç –Ω–∞ —Ç–æ–π –∂–µ –º–∞—à–∏–Ω–µ, —Å–¥–µ–ª–∞–π SSH-—Ç—É–Ω–Ω–µ–ª—å –∏–ª–∏ –≤—ã–±–µ—Ä–∏ Web3.Storage.");
    const u = apiBase.replace(/\/+$/,'') + "/add?pin=true&wrap-with-directory=false&progress=false";
    const fd = new FormData(); fd.append("file", blob, blob?.name || "file");
    const res = await fetch(u, { method:"POST", body: fd });
    if (!res.ok) throw new Error(`IPFS local error: ${res.status} ${res.statusText}`);
    const text = await res.text(); const lines = text.trim().split(/\r?\n/); const last = JSON.parse(lines[lines.length-1]);
    if (!last?.Hash) throw new Error("IPFS local: CID –Ω–µ –ø–æ–ª—É—á–µ–Ω"); return last.Hash;
  }
  async function uploadFile(storageKind, ipfsApi, w3sToken, blob){
    if (storageKind === "ipfs-local"){
      try { return await ipfsAddLocal(ipfsApi, blob); }
      catch (e){ log("‚ö†Ô∏è Local IPFS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: "+(e.message||e)); if (w3sToken){ log("‚§¥Ô∏è –§–æ–ª–±—ç–∫ –Ω–∞ Web3.Storage..."); return await uploadWeb3StorageWithRetry(w3sToken, blob); } throw e; }
    } else { return await uploadWeb3StorageWithRetry(w3sToken, blob); }
  }

  // ======= –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ =======
  async function anchorAndMint(){
    try{
      if (!signer) { alert("–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ (–±—Ä–∞—É–∑–µ—Ä/QR)."); return; }
      await ensureBaseSepolia();

      const f = $("file").files[0];
      const name = ($("project").value || "Whitepaper").trim();
      const storageKind = $("storage").value;
      const ipfsApi = $("ipfsApi").value.trim();
      const w3stoken = $("w3stoken").value.trim();
      const truncateN = Math.max(8, Math.min(62, Number($("truncateN").value||16)));
      const userSalt  = $("userSalt").value || "";

      if (!f) throw new Error("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
      if (storageKind==="web3" && !w3stoken) throw new Error("–£–∫–∞–∂–∏—Ç–µ Web3.Storage —Ç–æ–∫–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ Local IPFS.");

      const fileU8 = await fileToUint8(f);
      const docHash = keccakHex(fileU8);
      log("üîí docHash (keccak256(file)): "+docHash);

      let text=""; try { text = new TextDecoder("utf-8",{fatal:false}).decode(fileU8); } catch {}
      const stats = computeStats(text);
      const ts = nowWithHiRes();
      const forensicPayload = { version:1, fileName:f.name, fileSize:f.size, timeISO:ts.iso, timeMicro:ts.micro, nonce:ts.nonce, userSalt, stats };
      const fullHash = keccakHex(ethers.toUtf8Bytes(JSON.stringify(forensicPayload)));
      const truncated = "0x" + fullHash.slice(2, 2+truncateN);
      $("fullHashBox").style.display="block"; $("fullHash").textContent=fullHash; $("truncPreview").textContent=truncated;
      log("üß™ CreatorProofHash (full): "+fullHash);
      log("‚úÇÔ∏è truncated("+truncateN+"): "+truncated);
      log("‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ–ª–Ω—ã–π CreatorProofHash ‚Äî –æ–Ω –Ω–∏–≥–¥–µ –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è!");

      const fileCID = await uploadFile(storageKind, ipfsApi, w3stoken, f);
      log("üìÑ File CID: "+fileCID);

      const metadata = {
        name,
        description: "Anchored whitepaper bound to an EVM address on Base Sepolia",
        attributes: [
          { trait_type:"docHash", value:docHash },
          { trait_type:"fileCID", value:fileCID },
          { trait_type:"truncatedCreatorHash", value:truncated },
          { trait_type:"anchoredAt", value:new Date().toISOString() }
        ]
      };
      const metaBlob = new Blob([JSON.stringify(metadata)],{type:"application/json"});
      const metaCID = await uploadFile(storageKind, ipfsApi, w3stoken, metaBlob);
      const tokenURI = `ipfs://${metaCID}`;
      log("üßæ Metadata CID: "+metaCID);
      log("üîó tokenURI: "+tokenURI);

      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      const tx = await contract.anchor(docHash, fileCID, tokenURI);
      $("basescan").href = `${BASE_SEPOLIA.explorer}/tx/${tx.hash}`;
      log("‚è±Ô∏è tx: "+tx.hash);
      const rcpt = await tx.wait();
      const tid = (await contract.tokenCounter()).toString();
      log("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –≤ –±–ª–æ–∫–µ "+rcpt.blockNumber+"\\nüé® tokenId: "+tid);

      const did = { id:`did:ethr:${account}#whitepaper`, type:"DocumentAnchor",
        serviceEndpoint:{ docHash, fileCID:`ipfs://${fileCID}`, nftContract:CONTRACT_ADDRESS, tokenId:tid, truncatedCreatorHash:truncated } };
      log("\\nüëâ DID service entry:\\n"+JSON.stringify(did,null,2));

    }catch(e){ console.error(e); log("‚ùå "+(e.message||e)); alert(e.message||e); }
  }

  // ======= –ö–Ω–æ–ø–∫–∏ =======
  $("btnConnectInjected").onclick = connectInjected;
  $("btnConnectQR").onclick       = connectQR;
  $("btnEnsureBase").onclick      = ensureBaseSepolia;
  $("btnGo").onclick              = anchorAndMint;
  $("btnClear").onclick           = ()=>{ $("log").textContent=""; $("fullHashBox").style.display="none"; };

  // ======= –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ =======
  log("‚ÑπÔ∏è –•—Ä–∞–Ω–∏–ª–∏—â–µ: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Local IPFS (http://127.0.0.1:5001/api/v0). –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Docker Kubo –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç CORS –¥–ª—è –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞.");
  log("‚ÑπÔ∏è –î–ª—è QR-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à WalletConnect projectId –≤ WC_PROJECT_ID –∏ –¥–æ–±–∞–≤—å—Ç–µ https://did.run.place –≤ Allowlist –ø—Ä–æ–µ–∫—Ç–∞.");
})();
</script>
</body>
</html>
