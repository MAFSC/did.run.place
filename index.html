<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DID Anchor dApp ¬∑ Base Sepolia ¬∑ Local IPFS + QR/Browser</title>
<style>
  :root{--bg:#0b0d10;--card:#141820;--muted:#8a94a7}
  *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;background:var(--bg);color:#e5ebf5}
  .wrap{max-width:980px;margin:0 auto;padding:28px}
  .card{background:#141820;border:1px solid #1f2430;border-radius:16px;padding:18px}
  h1{margin:0 0 12px;font-size:22px}.muted{color:#8a94a7}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  input[type=text],input[type=number],input[type=file],select{width:100%;background:#0f131a;border:1px solid #202634;border-radius:12px;padding:12px 14px;color:#e5ebf5}
  .btn{border:1px solid #2c3545;background:#101521;color:#e5ebf5;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#22d3ee,#a78bfa);border:none}
  .warn{background:#20110f;border:1px solid #3a1c17;border-radius:12px;padding:12px;margin:10px 0;color:#ffb4a6}
  .log{background:#0f131a;border:1px dashed #293248;border-radius:12px;padding:12px;min-height:180px;white-space:pre-wrap}
  .kvs{display:grid;grid-template-columns:160px 1fr;gap:8px;font-size:13px}
  a.link{color:#8dd6ff;text-decoration:none}
</style>
<!-- ethers v6 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js" crossorigin="anonymous"></script>
<!-- –ª–æ–∫–∞–ª—å–Ω—ã–π WalletConnect UMD -->
<script src="/wc/index.umd.js" defer></script>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>DID Anchor dApp <span style="font-size:12px;color:#9fb3c8">Base Sepolia ¬∑ Local IPFS</span></h1>
  <p class="muted">–ü–æ–¥–∫–ª—é—á–∏ <b>Phantom/MetaMask (–±—Ä–∞—É–∑–µ—Ä)</b> –∏–ª–∏ —á–µ—Ä–µ–∑ <b>QR (WalletConnect)</b>. DApp –ø–æ—Å—á–∏—Ç–∞–µ—Ç <span class="mono">keccak256(file)</span>, –∑–∞–≥—Ä—É–∑–∏—Ç —Ñ–∞–π–ª+metadata –≤ <b>–ª–æ–∫–∞–ª—å–Ω—ã–π IPFS</b> (Kubo) –∏ –≤—ã–∑–æ–≤–µ—Ç <span class="mono">anchor</span> –Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ.</p>

  <div class="warn"><b>–í–ê–ñ–ù–û:</b> –ù–∏–∂–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω <b>–ü–æ–ª–Ω—ã–π —Ñ–æ—Ä–µ–Ω–∑–∏–∫-—Ö—ç—à (CreatorProofHash)</b>. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –≤ –Ω–∞–¥—ë–∂–Ω–æ–º –º–µ—Å—Ç–µ. –í NFT –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –∑–∞–ø–∏—Å–∞–Ω <b>—Ç–æ–ª—å–∫–æ –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π</b> —Ö—ç—à. –ü–æ—Ç–µ—Ä—è–µ—Ç–µ –ø–æ–ª–Ω—ã–π —Ö—ç—à ‚Äî –ø–æ—Ç–µ—Ä—è–µ—Ç–µ —Ä—ã—á–∞–≥–∏ –¥–æ–∫–∞–∑—ã–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞.</div>

  <h3>1) –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞</h3>
  <div class="row" style="margin-bottom:10px">
    <button id="btnConnectInjected" class="btn primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ (Phantom/MetaMask)</button>
    <button id="btnConnectQR" class="btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ QR (WalletConnect)</button>
  </div>
  <div class="row" style="margin-bottom:14px">
    <button id="btnEnsureBase" class="btn">–£–±–µ–¥–∏—Ç—å—Å—è –≤ —Å–µ—Ç–∏ Base Sepolia</button>
    <a id="basescan" class="btn" target="_blank" rel="noopener">Basescan</a>
  </div>
  <div id="who" class="kvs" style="display:none;margin-bottom:10px">
    <div>–ê–¥—Ä–µ—Å</div><div class="mono" id="addr">‚Äî</div>
    <div>–°–µ—Ç—å</div><div class="mono" id="net">‚Äî</div>
  </div>

  <h3>2) –•—Ä–∞–Ω–∏–ª–∏—â–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π IPFS)</h3>
  <div class="row" style="margin-bottom:10px">
    <select id="storage">
      <option value="ipfs-local" selected>IPFS Local (http://127.0.0.1:5001/api/v0)</option>
      <option value="web3">Web3.Storage (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)</option>
    </select>
    <input type="text" id="ipfsApi" value="http://127.0.0.1:5001/api/v0" placeholder="IPFS API endpoint (add)"/>
  </div>
  <div class="row" id="w3sRow" style="display:none;margin-bottom:10px">
    <input type="text" id="w3stoken" placeholder="Web3.Storage API Token (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)"/>
    <div></div>
  </div>

  <h3>3) –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ö—ç—à–∞</h3>
  <div class="row" style="margin-bottom:10px">
    <input type="text" id="project" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (–≤ NFT)"/>
    <input type="file" id="file" accept=".pdf,.txt,.md,.doc,.docx"/>
  </div>
  <div class="row" style="margin-bottom:10px">
    <input type="text" id="userSalt" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ (–∏–¥—ë—Ç –≤ —Ö—ç—à, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"/>
    <input type="number" id="truncateN" min="8" max="62" step="2" value="16" placeholder="–î–ª–∏–Ω–∞ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ —Ö—ç—à–∞ (hex —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ—Å–ª–µ 0x)"/>
  </div>

  <div class="warn" id="fullHashBox" style="display:none">
    <div><b>–ü–æ–ª–Ω—ã–π CreatorProofHash:</b> <span class="mono" id="fullHash">‚Äî</span></div>
    <div style="margin-top:4px">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ö—ç—à! –í NFT –ø–æ–ø–∞–¥—ë—Ç —Ç–æ–ª—å–∫–æ –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π: <span class="mono" id="truncPreview">‚Äî</span></div>
  </div>

  <div class="row" style="margin-bottom:8px">
    <button id="btnGo" class="btn primary">‚õìÔ∏è Anchor & Mint</button>
    <button id="btnClear" class="btn">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
  </div>

  <h3>–õ–æ–≥</h3>
  <div id="log" class="log"></div>

  <div style="margin-top:10px;color:#9fb3c8;font-size:12px">
    –ö–æ–Ω—Ç—Ä–∞–∫—Ç: <span class="mono" id="caddr">0x652Aec14a474dEb389574955d234C742D1936bE5</span> ¬∑
    –°–µ—Ç—å: <span class="mono">Base Sepolia (84532)</span> ¬∑
    –§–∞—É—Å–µ—Ç: <a class="link" href="https://www.alchemy.com/faucets/base-sepolia" target="_blank">Alchemy Faucet</a>
  </div>
</div></div>

<script>
(function(){
  // ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ =====
  const CONTRACT_ADDRESS = "0x652Aec14a474dEb389574955d234C742D1936bE5";
  const WC_PROJECT_ID    = "5a95e16a786fd5c436a5b7064b09a63c"; // ‚Üê –≤—Å—Ç–∞–≤—å —Å–≤–æ–π projectId (–¥–ª—è QR)
  const BASE_SEPOLIA = {
    chainId: 84532,
    hex: "0x14A34",
    name: "Base Sepolia",
    rpcUrl: "https://sepolia.base.org",
    explorer: "https://sepolia.basescan.org"
  };
  const ABI = [
    "function anchor(bytes32 docHash, string fileCID, string tokenURI) external returns (uint256)",
    "function tokenCounter() view returns (uint256)"
  ];
  const $  =(id)=>document.getElementById(id);
  const log=(m)=>{ const el=$("log"); el.textContent+=(m+"\\n"); el.scrollTop=el.scrollHeight; };
  const setKV=(k,v)=>$(k).textContent=v;
  $("basescan").href = `${BASE_SEPOLIA.explorer}/address/${CONTRACT_ADDRESS}`;
  $("caddr").textContent = CONTRACT_ADDRESS;

  // ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (–∫–æ—à–µ–ª—ë–∫) =====
  let providerType = null;          // 'injected' | 'walletconnect'
  let ethProv = null;               // EIP-1193 —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π
  let ethersProvider = null, signer = null, account = null;

  // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Ä—è–¥–∞ —Å —Ç–æ–∫–µ–Ω–æ–º Web3.Storage
  $("storage").addEventListener("change", ()=>{
    const v = $("storage").value;
    $("w3sRow").style.display = (v==="web3") ? "grid" : "none";
  });

  // ===== 1) –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ =====
  async function connectInjected(){
    if (!window.ethereum) { alert("–ë—Ä–∞—É–∑–µ—Ä–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Phantom (Enable Ethereum) –∏–ª–∏ MetaMask."); return; }
    ethProv = window.ethereum; providerType='injected';
    await ethProv.request({ method:"eth_requestAccounts" });
    ethersProvider = new ethers.BrowserProvider(ethProv);
    signer = await ethersProvider.getSigner();
    account = await signer.getAddress();
    const net = await ethersProvider.getNetwork();
    setKV("addr", account);
    setKV("net", `${net.name || 'EVM'} (${Number(net.chainId)})`);
    $("who").style.display="grid";
    log("‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ: "+(ethProv.isPhantom?"Phantom":ethProv.isMetaMask?"MetaMask":"EVM wallet"));
    await ensureBaseSepolia();
  }

  // ===== 2) –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: QR (WalletConnect) =====
  async function connectQR(){
    const WCGlobal = window.WalletConnectEthereumProvider || window.EthereumProvider;
    if (!WCGlobal) { alert("QR –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –Ω–µ –Ω–∞–π–¥–µ–Ω /wc/index.umd.js"); log("‚ùå QR: –ª–æ–∫–∞–ª—å–Ω—ã–π WalletConnect UMD –Ω–µ –Ω–∞–π–¥–µ–Ω."); return; }
    if (!WC_PROJECT_ID || WC_PROJECT_ID.includes("PASTE_YOUR")) { alert("–£–∫–∞–∂–∏ WalletConnect projectId –≤ –∫–æ–¥–µ."); return; }
    const EthereumProvider = WCGlobal.default || WCGlobal;
    ethProv = await EthereumProvider.init({
      projectId: WC_PROJECT_ID,
      chains:[BASE_SEPOLIA.chainId],
      optionalChains:[BASE_SEPOLIA.chainId],
      rpcMap:{[BASE_SEPOLIA.chainId]: BASE_SEPOLIA.rpcUrl},
      showQrModal:true,
      metadata:{ name:"DID Anchor dApp", description:"Anchor & Mint on Base Sepolia", url:location.origin, icons:["https://did.run.place/favicon.ico"] }
    });
    providerType='walletconnect';
    await ethProv.enable();
    ethersProvider = new ethers.BrowserProvider(ethProv);
    signer = await ethersProvider.getSigner();
    const accs = await ethProv.request({method:"eth_accounts"});
    account = accs?.[0] || (await signer.getAddress());
    const net = await ethersProvider.getNetwork();
    setKV("addr", account);
    setKV("net", `${net.name || 'Base Sepolia'} (${Number(net.chainId)})`);
    $("who").style.display="grid";
    log("‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ —á–µ—Ä–µ–∑ WalletConnect (QR): "+account);
    await ensureBaseSepolia();
  }

  async function ensureBaseSepolia(){
    if (!ethProv) { alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫."); return; }
    const net = await (new ethers.BrowserProvider(ethProv)).getNetwork();
    if (Number(net.chainId) === BASE_SEPOLIA.chainId) { setKV("net", `${net.name||"Base Sepolia"} (${Number(net.chainId)})`); return; }
    try {
      await ethProv.request({ method:"wallet_switchEthereumChain", params:[{ chainId: BASE_SEPOLIA.hex }] });
    } catch (e) {
      if (e && (e.code===4902 || /Unrecognized/i.test(String(e.message||"")))) {
        await ethProv.request({ method:"wallet_addEthereumChain", params:[{
          chainId: BASE_SEPOLIA.hex, chainName: BASE_SEPOLIA.name,
          nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18},
          rpcUrls:[BASE_SEPOLIA.rpcUrl], blockExplorerUrls:[BASE_SEPOLIA.explorer]
        }]});
      } else { throw e; }
    }
    const net2 = await (new ethers.BrowserProvider(ethProv)).getNetwork();
    setKV("net", `${net2.name||"Base Sepolia"} (${Number(net2.chainId)})`);
    log("‚úì –°–µ—Ç—å: Base Sepolia");
  }

  // ======== –§–æ—Ä–µ–Ω–∑–∏–∫-–º–µ—Ç—Ä–∏–∫–∏ –∏ —Ö—ç—à–∏ ========
  const vowelsRe = /[AEIOUY–ê–ï–Å–ò–û–£–´–≠–Æ–Øaeiouy–∞–µ—ë–∏–æ—É—ã—ç—é—è]/u;
  function computeStats(txt){
    const letters = txt.match(/\p{L}/gu) || [];               // –≤—Å–µ –±—É–∫–≤—ã (–ª—é–±–æ–π –∞–ª—Ñ–∞–≤–∏—Ç)
    const words   = txt.match(/\p{L}+/gu) || [];
    const spaces  = (txt.match(/[\u0020]/g) || []).length;    // –ø—Ä–æ–±–µ–ª—ã
    const points  = (txt.match(/[.]/g) || []).length;
    const commas  = (txt.match(/[,]/g) || []).length;
    const punct   = (txt.match(/[!"#$%&'()*+,\-.\/:;<=>?@[\\\]^_`{|}~‚Ä¶‚Äî‚Äì]/g) || []).length;
    let vowels=0, consonants=0, upper=0, lower=0;
    letters.forEach(ch=>{
      const isVowel = vowelsRe.test(ch);
      if (isVowel) vowels++; else consonants++;
      if (ch === ch.toUpperCase() && ch !== ch.toLowerCase()) upper++;
      if (ch === ch.toLowerCase() && ch !== ch.toUpperCase()) lower++;
    });
    // —á–∞—Å—Ç–æ—Ç—ã –Ω–∞—á–∞–ª—å–Ω—ã—Ö –±—É–∫–≤ —Å–ª–æ–≤ (–ª–∞—Ç–∏–Ω–∏—Ü–∞ + –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
    const freqInit = {};
    const alph = [..."ABCDEFGHIJKLMNOPQRSTUVWXYZ"];
    const calph = [..."–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø"];
    [...alph, ...calph].forEach(l=>freqInit[l]=0);
    words.forEach(w=>{
      const first = w[0].toUpperCase();
      if (freqInit[first]!=null) freqInit[first] += 1;
    });
    return {
      totalLetters: letters.length,
      totalWords: words.length,
      vowels, consonants,
      spaces,
      punctuationTotal: punct,
      dots: points,
      commas: commas,
      uppercase: upper,
      lowercase: lower,
      freqInitialLetter: freqInit
    };
  }

  function nowWithHiRes(){
    const iso = new Date().toISOString();
    const perf = (typeof performance!=="undefined" && performance.now) ? performance.now() : Math.random()*1e3;
    // –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥—ã (6 –∑–Ω–∞–∫–æ–≤) + —Å–ª—É—á–∞–π–Ω—ã–π nonce –¥–ª—è —ç–Ω—Ç—Ä–æ–ø–∏–∏
    const micro = Math.round(perf*1000); // Œºs
    const nonce = crypto.getRandomValues(new Uint32Array(2));
    return { iso, micro, nonce: Array.from(nonce) };
  }

  function keccakHex(u8){
    return ethers.keccak256(u8); // 0x...
  }

  async function fileToUint8(file){
    const buf = await file.arrayBuffer();
    return new Uint8Array(buf);
  }

  // ======== IPFS –∑–∞–≥—Ä—É–∑–∫–∞ ========
  async function ipfsAddLocal(apiBase, blob){
    // POST /api/v0/add (multipart/form-data)
    const u = apiBase.replace(/\/+$/,'') + "/add?pin=true&wrap-with-directory=false&progress=false";
    const fd = new FormData();
    fd.append("file", blob, (blob && blob.name) ? blob.name : "file");
    const res = await fetch(u, { method:"POST", body: fd });
    if(!res.ok) throw new Error("IPFS local error: "+res.status+" "+res.statusText);
    const text = await res.text(); // Kubo –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫; –≤–æ–∑—å–º—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π JSON
    const lines = text.trim().split(/\r?\n/);
    const last = JSON.parse(lines[lines.length-1]);
    return last.Hash; // CIDv0/1
  }

  async function uploadWeb3Storage(token, blob){
    const res = await fetch("https://api.web3.storage/upload", { method:"POST", headers:{ Authorization:`Bearer ${token}` }, body:blob });
    if(!res.ok) throw new Error("Web3.Storage error: "+res.status+" "+res.statusText);
    return (await res.json()).cid;
  }

  async function uploadFile(storageKind, ipfsApi, w3sToken, blob){
    if (storageKind==="ipfs-local") return await ipfsAddLocal(ipfsApi, blob);
    return await uploadWeb3Storage(w3sToken, blob);
  }

  // ======== –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É: Anchor & Mint ========
  async function anchorAndMint(){
    try{
      if (!signer) { alert("–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ (–±—Ä–∞—É–∑–µ—Ä/QR)."); return; }
      await ensureBaseSepolia();

      const f = $("file").files[0];
      const name = ($("project").value || "Whitepaper").trim();
      const storageKind = $("storage").value;
      const ipfsApi = $("ipfsApi").value.trim();
      const w3stoken = $("w3stoken").value.trim();
      const truncateN = Math.max(8, Math.min(62, Number($("truncateN").value||16)));
      const userSalt  = $("userSalt").value || "";

      if (!f) throw new Error("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
      if (storageKind==="web3" && !w3stoken) throw new Error("–£–∫–∞–∂–∏—Ç–µ Web3.Storage —Ç–æ–∫–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ Local IPFS.");

      // docHash (–ø–æ —Ñ–∞–π–ª—É)
      const fileU8 = await fileToUint8(f);
      const docHash = keccakHex(fileU8);
      log("üîí docHash (keccak256(file)): "+docHash);

      // –¢–µ–∫—Å—Ç –¥–ª—è –º–µ—Ç—Ä–∏–∫ (–ø–æ–ø—ã—Ç–∞–µ–º—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ UTF-8 ‚Äî –æ–∫ –¥–ª—è .txt/.md; –¥–ª—è pdf/docx –±—É–¥–µ—Ç ¬´—à—É–º¬ª, —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ –¥–ª—è –∏–¥–µ–∏)
      let text;
      try { text = new TextDecoder("utf-8",{fatal:false}).decode(fileU8); }
      catch { text = ""; }
      const stats = computeStats(text);

      // –≤—Ä–µ–º—è + nonce
      const ts = nowWithHiRes();

      // —Ñ–æ—Ä–µ–Ω–∑–∏–∫-—Å—Ç—Ä–æ–∫–∞ (–º–∏–Ω–∏–º—É–º: –º–µ—Ç—Ä–∏–∫–∏ + –≤—Ä–µ–º—è + userSalt + –∏–º—è —Ñ–∞–π–ª–∞ + —Ä–∞–∑–º–µ—Ä)
      const forensicPayload = {
        version: 1,
        fileName: f.name,
        fileSize: f.size,
        timeISO: ts.iso,
        timeMicro: ts.micro,    // –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∫ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        nonce: ts.nonce,        // —Å–ª—É—á–∞–π–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è —ç–Ω—Ç—Ä–æ–ø–∏–∏
        userSalt,
        stats
      };
      const forensicStr = JSON.stringify(forensicPayload);
      const fullHash = keccakHex(ethers.toUtf8Bytes(forensicStr)); // –ø–æ–ª–Ω—ã–π CreatorProofHash (—Å–µ–∫—Ä–µ—Ç)
      const truncated = "0x" + fullHash.slice(2, 2+truncateN);

      // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ¬´—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª
      $("fullHashBox").style.display = "block";
      $("fullHash").textContent = fullHash;
      $("truncPreview").textContent = truncated;
      log("üß™ CreatorProofHash (full): "+fullHash+"\n‚úÇÔ∏è truncated("+truncateN+"): "+truncated);
      log("‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ–ª–Ω—ã–π CreatorProofHash ‚Äî –æ–Ω –Ω–∏–≥–¥–µ –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è!");

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
      const fileCID = await uploadFile(storageKind, ipfsApi, w3stoken, f);
      log("üìÑ File CID: "+fileCID);

      // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–ø—É–±–ª–∏—á–Ω—ã–µ): –ü–ò–®–ï–ú –¢–û–õ–¨–ö–û –û–ë–†–ï–ó–ê–ù–ù–´–ô –•–≠–®!
      const metadata = {
        name,
        description: "Anchored whitepaper bound to an EVM address on Base Sepolia",
        attributes: [
          { trait_type:"docHash", value:docHash },
          { trait_type:"fileCID", value:fileCID },
          { trait_type:"truncatedCreatorHash", value:truncated },
          { trait_type:"anchoredAt", value:new Date().toISOString() }
        ]
      };
      const metaBlob = new Blob([JSON.stringify(metadata)],{type:"application/json"});

      const metaCID = await uploadFile(storageKind, ipfsApi, w3stoken, metaBlob);
      const tokenURI = `ipfs://${metaCID}`;
      log("üßæ Metadata CID: "+metaCID+"\nüîó tokenURI: "+tokenURI);

      // –í—ã–∑–æ–≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      const tx = await contract.anchor(docHash, fileCID, tokenURI);
      $("basescan").href = `${BASE_SEPOLIA.explorer}/tx/${tx.hash}`;
      log("‚è±Ô∏è tx: "+tx.hash);
      const rcpt = await tx.wait();
      const tid = (await contract.tokenCounter()).toString();
      log("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –≤ –±–ª–æ–∫–µ "+rcpt.blockNumber+"\\nüé® tokenId: "+tid);

      // DID service entry (–ø—Ä–∏–º–µ—Ä)
      const did = { id:`did:ethr:${account}#whitepaper`, type:"DocumentAnchor",
        serviceEndpoint:{ docHash, fileCID:`ipfs://${fileCID}`, nftContract:CONTRACT_ADDRESS, tokenId:tid, truncatedCreatorHash:truncated } };
      log("\\nüëâ DID service entry:\\n"+JSON.stringify(did,null,2));

    }catch(e){ console.error(e); log("‚ùå "+(e.message||e)); alert(e.message||e); }
  }

  // ===== –ö–Ω–æ–ø–∫–∏ =====
  $("btnConnectInjected").onclick = connectInjected;
  $("btnConnectQR").onclick       = connectQR;
  $("btnEnsureBase").onclick      = ensureBaseSepolia;
  $("btnGo").onclick              = anchorAndMint;
  $("btnClear").onclick           = ()=>{ $("log").textContent=""; $("fullHashBox").style.display="none"; };

  // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  log("‚ÑπÔ∏è –•—Ä–∞–Ω–∏–ª–∏—â–µ: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Local IPFS (http://127.0.0.1:5001/api/v0). –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Docker Kubo –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç CORS –¥–ª—è –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞.");
  log("‚ÑπÔ∏è –î–ª—è QR-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à WalletConnect projectId –≤ WC_PROJECT_ID –∏ –¥–æ–±–∞–≤—å—Ç–µ https://did.run.place –≤ Allowlist –ø—Ä–æ–µ–∫—Ç–∞.");
})();
</script>
</body>
</html>
