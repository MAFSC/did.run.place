<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DID Anchor dApp · Base Sepolia · Local IPFS + QR/Browser</title>
<style>
  :root{--bg:#0b0d10;--card:#141820;--muted:#8a94a7}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;background:var(--bg);color:#e5ebf5}
  .wrap{max-width:980px;margin:0 auto;padding:28px}
  .card{background:#141820;border:1px solid #1f2430;border-radius:16px;padding:18px}
  h1{margin:0 0 12px;font-size:22px}
  .muted{color:#8a94a7}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  input[type=text],input[type=number],input[type=file],select{width:100%;background:#0f131a;border:1px solid #202634;border-radius:12px;padding:12px 14px;color:#e5ebf5}
  .btn{border:1px solid #2c3545;background:#101521;color:#e5ebf5;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#22d3ee,#a78bfa);border:none}
  .warn{background:#20110f;border:1px solid #3a1c17;border-radius:12px;padding:12px;margin:10px 0;color:#ffb4a6}
  .ok{background:#112016;border:1px solid #1b3a2a;border-radius:12px;padding:12px;margin:10px 0;color:#b9ffcb}
  .log{background:#0f131a;border:1px dashed #293248;border-radius:12px;padding:12px;min-height:180px;white-space:pre-wrap}
  .kvs{display:grid;grid-template-columns:160px 1fr;gap:8px;font-size:13px}
  a.link{color:#8dd6ff;text-decoration:none}
</style>
<!-- ethers v6 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js" crossorigin="anonymous"></script>
<!-- попытаемся загрузить локальный WalletConnect UMD; при клике QR сделаем и CDN-фолбэк -->
<script src="/wc/index.umd.js" defer></script>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>DID Anchor dApp <span style="font-size:12px;color:#9fb3c8">Base Sepolia · Local IPFS</span></h1>
  <p class="muted">
    Подключи <b>Phantom/MetaMask (браузер)</b> или <b>QR (WalletConnect)</b>.
    DApp считает <span class="mono">keccak256(file)</span>, загружает файл и metadata в <b>локальный IPFS</b> (Kubo) или <b>Web3.Storage</b>, и вызывает <span class="mono">anchor</span> на контракте.
  </p>

  <div class="warn"><b>ВАЖНО:</b> Ниже будет сгенерирован <b>полный форензик-хэш (CreatorProofHash)</b>. Сохраните его!
    В NFT/метаданные записывается только <b>обрезанный</b> хэш. Потеряете полный — потеряете рычаги доказывания авторства.
  </div>

  <h3>1) Подключение кошелька</h3>
  <div class="row" style="margin-bottom:10px">
    <button id="btnConnectInjected" class="btn primary">Подключить браузерный кошелёк (Phantom/MetaMask)</button>
    <button id="btnConnectQR" class="btn">Подключить через QR (WalletConnect)</button>
  </div>
  <div class="row" style="margin-bottom:14px">
    <button id="btnEnsureBase" class="btn">Убедиться в сети Base Sepolia</button>
    <a id="basescan" class="btn" target="_blank" rel="noopener">Basescan</a>
  </div>
  <div id="who" class="kvs" style="display:none;margin-bottom:10px">
    <div>Адрес</div><div class="mono" id="addr">—</div>
    <div>Сеть</div><div class="mono" id="net">—</div>
  </div>

  <h3>2) Хранилище</h3>
  <div class="row" style="margin-bottom:10px">
    <select id="storage">
      <option value="ipfs-local" selected>IPFS Local (http://127.0.0.1:5001/api/v0)</option>
      <option value="web3">Web3.Storage (нужен токен)</option>
    </select>
    <input type="text" id="ipfsApi" value="http://127.0.0.1:5001/api/v0" placeholder="IPFS API endpoint (add)"/>
  </div>
  <div class="row" id="w3sRow" style="display:none;margin-bottom:10px">
    <input type="text" id="w3stoken" placeholder="Web3.Storage API Token (если используете Web3.Storage)"/>
    <div></div>
  </div>

  <h3>3) Данные для хэша</h3>
  <div class="row" style="margin-bottom:10px">
    <input type="text" id="project" placeholder="Название проекта (в NFT)"/>
    <input type="file" id="file" accept=".pdf,.txt,.md,.doc,.docx"/>
  </div>
  <div class="row" style="margin-bottom:10px">
    <input type="text" id="userSalt" placeholder="Секретное слово/фраза (идёт в хэш, опционально)"/>
    <input type="number" id="truncateN" min="8" max="62" step="2" value="16" placeholder="Длина обрезанного хэша (hex)"/>
  </div>

  <div class="warn" id="fullHashBox" style="display:none">
    <div><b>Полный CreatorProofHash:</b> <span class="mono" id="fullHash">—</span></div>
    <div style="margin-top:4px">В NFT попадёт только: <span class="mono" id="truncPreview">—</span></div>
  </div>

  <div class="row" style="margin-bottom:8px">
    <button id="btnGo" class="btn primary">⛓️ Anchor & Mint</button>
    <button id="btnClear" class="btn">Очистить лог</button>
  </div>

  <h3>Лог</h3>
  <div id="log" class="log"></div>

  <div style="margin-top:10px;color:#9fb3c8;font-size:12px">
    Контракт: <span class="mono" id="caddr">0x652Aec14a474dEb389574955d234C742D1936bE5</span> ·
    Сеть: <span class="mono">Base Sepolia (84532)</span> ·
    Фаусет: <a class="link" href="https://www.alchemy.com/faucets/base-sepolia" target="_blank">Alchemy Faucet</a>
  </div>
</div></div>

<script>
(function(){
  // ======= Константы =======
  const CONTRACT_ADDRESS = "0x652Aec14a474dEb389574955d234C742D1936bE5";
  const WC_PROJECT_ID    = "5a95e16a786fd5c436a5b7064b09a63c"; // ← ВСТАВЬ СВОЙ projectId
  const BASE_SEPOLIA = {
    chainId: 84532, hex: "0x14A34",
    name: "Base Sepolia",
    rpcUrl: "https://sepolia.base.org",
    explorer: "https://sepolia.basescan.org"
  };
  const ABI = [
    "function anchor(bytes32 docHash, string fileCID, string tokenURI) external returns (uint256)",
    "function tokenCounter() view returns (uint256)"
  ];

  const $  =(id)=>document.getElementById(id);
  const log=(m)=>{ const el=$("log"); el.textContent+=(m+"\\n"); el.scrollTop=el.scrollHeight; };
  const setKV=(k,v)=>$(k).textContent=v;

  $("basescan").href = `${BASE_SEPOLIA.explorer}/address/${CONTRACT_ADDRESS}`;
  $("caddr").textContent = CONTRACT_ADDRESS;

  // ======= Провайдеры =======
  let providerType = null; // 'injected' | 'walletconnect'
  let ethProv = null;      // EIP-1193
  let ethersProvider = null, signer = null, account = null;

  // Показ/скрытие токена Web3.Storage
  $("storage").addEventListener("change", ()=>{
    $("w3sRow").style.display = ($("storage").value === "web3") ? "grid" : "none";
  });

  // ======= Загрузка WC UMD (локально + CDN фолбэк) =======
  async function ensureWalletConnectUMD() {
    if (window.WalletConnectEthereumProvider || window.EthereumProvider) return;
    const loadScript = (src) => new Promise((res, rej) => {
      const s = document.createElement('script'); s.src = src;
      s.onload = res; s.onerror = () => rej(new Error('Failed '+src));
      document.head.appendChild(s);
    });
    try { await loadScript('/wc/index.umd.js'); } catch(_) {}
    if (window.WalletConnectEthereumProvider || window.EthereumProvider) return;
    try { await loadScript('https://unpkg.com/@walletconnect/ethereum-provider@2.21.8/dist/index.umd.js'); } catch(e){ console.error(e); }
  }

  // ======= Подключение: браузерный =======
  async function connectInjected(){
    if (!window.ethereum) { alert("Браузерный кошелёк не найден. Установите Phantom (Enable Ethereum) или MetaMask."); return; }
    ethProv = window.ethereum; providerType='injected';
    await ethProv.request({ method:"eth_requestAccounts" });
    ethersProvider = new ethers.BrowserProvider(ethProv);
    signer = await ethersProvider.getSigner();
    account = await signer.getAddress();
    const net = await ethersProvider.getNetwork();
    setKV("addr", account); setKV("net", `${net.name || 'EVM'} (${Number(net.chainId)})`);
    $("who").style.display="grid";
    log("✓ Подключено расширение: "+(ethProv.isPhantom?"Phantom":ethProv.isMetaMask?"MetaMask":"EVM wallet"));
    await ensureBaseSepolia();
  }

  // ======= Подключение: QR (WalletConnect) =======
  async function connectQR(){
    await ensureWalletConnectUMD();
    const WCGlobal = window.WalletConnectEthereumProvider || window.EthereumProvider;
    if (!WCGlobal) { alert("QR недоступен: не удалось загрузить WalletConnect UMD (локально и через CDN)."); log("❌ QR: UMD не найден."); return; }
    if (!WC_PROJECT_ID || WC_PROJECT_ID.includes("PASTE_YOUR")) { alert("Укажи WalletConnect projectId в коде (WC_PROJECT_ID)."); return; }
    const EthereumProvider = WCGlobal.default || WCGlobal;
    ethProv = await EthereumProvider.init({
      projectId: WC_PROJECT_ID,
      chains:[BASE_SEPOLIA.chainId],
      optionalChains:[BASE_SEPOLIA.chainId],
      rpcMap:{[BASE_SEPOLIA.chainId]: BASE_SEPOLIA.rpcUrl},
      showQrModal:true,
      metadata:{ name:"DID Anchor dApp", description:"Anchor & Mint on Base Sepolia", url:location.origin, icons:["https://did.run.place/favicon.ico"] }
    });
    providerType='walletconnect';
    await ethProv.enable();
    ethersProvider = new ethers.BrowserProvider(ethProv);
    signer = await ethersProvider.getSigner();
    const accs = await ethProv.request({method:"eth_accounts"});
    account = accs?.[0] || (await signer.getAddress());
    const net = await ethersProvider.getNetwork();
    setKV("addr", account); setKV("net", `${net.name || 'Base Sepolia'} (${Number(net.chainId)})`);
    $("who").style.display="grid";
    log("✓ Подключено через WalletConnect (QR): "+account);
    await ensureBaseSepolia();
  }

  // ======= Сеть Base Sepolia =======
  async function ensureBaseSepolia(){
    if (!ethProv) { alert("Сначала подключите кошелёк."); return; }
    const net = await (new ethers.BrowserProvider(ethProv)).getNetwork();
    if (Number(net.chainId) === BASE_SEPOLIA.chainId) { setKV("net", `${net.name||"Base Sepolia"} (${Number(net.chainId)})`); return; }
    try {
      await ethProv.request({ method:"wallet_switchEthereumChain", params:[{ chainId: BASE_SEPOLIA.hex }] });
    } catch (e) {
      if (e && (e.code===4902 || /Unrecognized/i.test(String(e.message||"")))) {
        await ethProv.request({ method:"wallet_addEthereumChain", params:[{
          chainId: BASE_SEPOLIA.hex, chainName: BASE_SEPOLIA.name,
          nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18},
          rpcUrls:[BASE_SEPOLIA.rpcUrl], blockExplorerUrls:[BASE_SEPOLIA.explorer]
        }]});
      } else { throw e; }
    }
    const net2 = await (new ethers.BrowserProvider(ethProv)).getNetwork();
    setKV("net", `${net2.name||"Base Sepolia"} (${Number(net2.chainId)})`);
    log("✓ Сеть: Base Sepolia");
  }

  // ======= Форензик-метрики =======
  const vowelsRe = /[AEIOUYАЕЁИОУЫЭЮЯaeiouyаеёиоуыэюя]/u;
  function computeStats(txt){
    const letters = txt.match(/\p{L}/gu) || [];
    const words   = txt.match(/\p{L}+/gu) || [];
    const spaces  = (txt.match(/[\u0020]/g) || []).length;
    const points  = (txt.match(/[.]/g) || []).length;
    const commas  = (txt.match(/[,]/g) || []).length;
    const punct   = (txt.match(/[!"#$%&'()*+,\-.\/:;<=>?@[\\\]^_`{|}~…—–]/g) || []).length;
    let vowels=0, consonants=0, upper=0, lower=0;
    letters.forEach(ch=>{
      const isVowel = vowelsRe.test(ch);
      if (isVowel) vowels++; else consonants++;
      if (ch === ch.toUpperCase() && ch !== ch.toLowerCase()) upper++;
      if (ch === ch.toLowerCase() && ch !== ch.toUpperCase()) lower++;
    });
    const freqInit = {};
    const alph = [..."ABCDEFGHIJKLMNOPQRSTUVWXYZ"];
    const calph = [..."АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ"];
    [...alph, ...calph].forEach(l=>freqInit[l]=0);
    words.forEach(w=>{
      const first = w[0].toUpperCase();
      if (freqInit[first]!=null) freqInit[first] += 1;
    });
    return { totalLetters: letters.length, totalWords: words.length, vowels, consonants, spaces,
      punctuationTotal: punct, dots: points, commas, uppercase: upper, lowercase: lower, freqInitialLetter: freqInit };
  }
  function nowWithHiRes(){
    const iso = new Date().toISOString();
    const perf = (typeof performance!=="undefined" && performance.now) ? performance.now() : Math.random()*1e3;
    const micro = Math.round(perf*1000); // μs
    const nonce = crypto.getRandomValues(new Uint32Array(2));
    return { iso, micro, nonce: Array.from(nonce) };
  }
  const keccakHex = (u8)=>ethers.keccak256(u8);
  async function fileToUint8(file){ const buf = await file.arrayBuffer(); return new Uint8Array(buf); }

  // ======= Проверка Local IPFS + Web3.Storage ретраи =======
  async function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
  async function checkLocalIpfsReachable(apiBase){
    try { const res = await fetch(apiBase.replace(/\/+$/,'')+"/version",{method:"POST"}); return res.ok; }
    catch { return false; }
  }
  async function uploadWeb3StorageWithRetry(token, blob, maxRetries = 5){
    if(!token) throw new Error("Укажите Web3.Storage токен");
    let attempt = 0, lastErr;
    while (attempt <= maxRetries){
      try{
        const res = await fetch("https://api.web3.storage/upload",{method:"POST",headers:{Authorization:`Bearer ${token}`},body: blob});
        if (res.status===401||res.status===403) throw new Error("Web3.Storage unauthorized (проверь токен)");
        if (!res.ok){
          if ((res.status===429||res.status===503) && attempt<maxRetries){ attempt++; await sleep(1000*attempt); continue; }
          throw new Error(`Web3.Storage error: ${res.status} ${res.statusText}`);
        }
        const j = await res.json();
        if (!j?.cid) throw new Error("Web3.Storage: пустой ответ");
        return j.cid;
      }catch(e){ lastErr=e; if (String(e).includes("Failed to fetch") && attempt<maxRetries){ attempt++; await sleep(1000*attempt); continue; } break; }
    }
    throw lastErr || new Error("Web3.Storage: не удалось загрузить");
  }
  async function ipfsAddLocal(apiBase, blob){
    const reachable = await checkLocalIpfsReachable(apiBase);
    if (!reachable) throw new Error("Local IPFS недоступен из браузера (127.0.0.1:5001). Открой сайт на той же машине, сделай SSH-туннель или выбери Web3.Storage.");
    const u = apiBase.replace(/\/+$/,'') + "/add?pin=true&wrap-with-directory=false&progress=false";
    const fd = new FormData(); fd.append("file", blob, blob?.name || "file");
    const res = await fetch(u, { method:"POST", body: fd });
    if (!res.ok) throw new Error(`IPFS local error: ${res.status} ${res.statusText}`);
    const text = await res.text(); const lines = text.trim().split(/\r?\n/); const last = JSON.parse(lines[lines.length-1]);
    if (!last?.Hash) throw new Error("IPFS local: CID не получен"); return last.Hash;
  }
  async function uploadFile(storageKind, ipfsApi, w3sToken, blob){
    if (storageKind === "ipfs-local"){
      try { return await ipfsAddLocal(ipfsApi, blob); }
      catch (e){ log("⚠️ Local IPFS недоступен: "+(e.message||e)); if (w3sToken){ log("⤴️ Фолбэк на Web3.Storage..."); return await uploadWeb3StorageWithRetry(w3sToken, blob); } throw e; }
    } else { return await uploadWeb3StorageWithRetry(w3sToken, blob); }
  }

  // ======= Основной поток =======
  async function anchorAndMint(){
    try{
      if (!signer) { alert("Подключите кошелёк (браузер/QR)."); return; }
      await ensureBaseSepolia();

      const f = $("file").files[0];
      const name = ($("project").value || "Whitepaper").trim();
      const storageKind = $("storage").value;
      const ipfsApi = $("ipfsApi").value.trim();
      const w3stoken = $("w3stoken").value.trim();
      const truncateN = Math.max(8, Math.min(62, Number($("truncateN").value||16)));
      const userSalt  = $("userSalt").value || "";

      if (!f) throw new Error("Выберите файл");
      if (storageKind==="web3" && !w3stoken) throw new Error("Укажите Web3.Storage токен или переключитесь на Local IPFS.");

      const fileU8 = await fileToUint8(f);
      const docHash = keccakHex(fileU8);
      log("🔒 docHash (keccak256(file)): "+docHash);

      let text=""; try { text = new TextDecoder("utf-8",{fatal:false}).decode(fileU8); } catch {}
      const stats = computeStats(text);
      const ts = nowWithHiRes();
      const forensicPayload = { version:1, fileName:f.name, fileSize:f.size, timeISO:ts.iso, timeMicro:ts.micro, nonce:ts.nonce, userSalt, stats };
      const fullHash = keccakHex(ethers.toUtf8Bytes(JSON.stringify(forensicPayload)));
      const truncated = "0x" + fullHash.slice(2, 2+truncateN);
      $("fullHashBox").style.display="block"; $("fullHash").textContent=fullHash; $("truncPreview").textContent=truncated;
      log("🧪 CreatorProofHash (full): "+fullHash);
      log("✂️ truncated("+truncateN+"): "+truncated);
      log("⚠️ Сохраните полный CreatorProofHash — он нигде не публикуется!");

      const fileCID = await uploadFile(storageKind, ipfsApi, w3stoken, f);
      log("📄 File CID: "+fileCID);

      const metadata = {
        name,
        description: "Anchored whitepaper bound to an EVM address on Base Sepolia",
        attributes: [
          { trait_type:"docHash", value:docHash },
          { trait_type:"fileCID", value:fileCID },
          { trait_type:"truncatedCreatorHash", value:truncated },
          { trait_type:"anchoredAt", value:new Date().toISOString() }
        ]
      };
      const metaBlob = new Blob([JSON.stringify(metadata)],{type:"application/json"});
      const metaCID = await uploadFile(storageKind, ipfsApi, w3stoken, metaBlob);
      const tokenURI = `ipfs://${metaCID}`;
      log("🧾 Metadata CID: "+metaCID);
      log("🔗 tokenURI: "+tokenURI);

      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      const tx = await contract.anchor(docHash, fileCID, tokenURI);
      $("basescan").href = `${BASE_SEPOLIA.explorer}/tx/${tx.hash}`;
      log("⏱️ tx: "+tx.hash);
      const rcpt = await tx.wait();
      const tid = (await contract.tokenCounter()).toString();
      log("✅ Подтверждено в блоке "+rcpt.blockNumber+"\\n🎨 tokenId: "+tid);

      const did = { id:`did:ethr:${account}#whitepaper`, type:"DocumentAnchor",
        serviceEndpoint:{ docHash, fileCID:`ipfs://${fileCID}`, nftContract:CONTRACT_ADDRESS, tokenId:tid, truncatedCreatorHash:truncated } };
      log("\\n👉 DID service entry:\\n"+JSON.stringify(did,null,2));

    }catch(e){ console.error(e); log("❌ "+(e.message||e)); alert(e.message||e); }
  }

  // ======= Кнопки =======
  $("btnConnectInjected").onclick = connectInjected;
  $("btnConnectQR").onclick       = connectQR;
  $("btnEnsureBase").onclick      = ensureBaseSepolia;
  $("btnGo").onclick              = anchorAndMint;
  $("btnClear").onclick           = ()=>{ $("log").textContent=""; $("fullHashBox").style.display="none"; };

  // ======= Подсказки при старте =======
  log("ℹ️ Хранилище: по умолчанию Local IPFS (http://127.0.0.1:5001/api/v0). Убедитесь, что Docker Kubo запущен и разрешает CORS для вашего домена.");
  log("ℹ️ Для QR-подключения подставьте ваш WalletConnect projectId в WC_PROJECT_ID и добавьте https://did.run.place в Allowlist проекта.");
})();
</script>
</body>
</html>
